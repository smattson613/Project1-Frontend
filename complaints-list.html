<!DOCTYPE html>
<html lang="en">

<head>
    <title>Complaints</title>
    <!-- this page will have all complaints listed with dropdown menus for assigning the priority to complaints -->
    <!-- this page will only be accessible to council members -->
    <!-- council members will be able to generate meetings that populate to the public meeting list -->
</head>

<body>
    <h1>Complaints List</h1>
    <nav><a href="file-complaint.html">Return to file complaint</a></nav>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Status</th>
                <th>Meeting ID</th>
                <th>High Priority</th>
                <th>Low Priority</th>
                <th>Ignore</th>
            </tr>
        </thead>
        <tbody id="pleaseWork"></tbody>
    </table>
</body>
<script>

    const complaintTableBody = document.getElementById("pleaseWork");

    async function getComplaints() {
        const httpResponse = await fetch('http://localhost:8080/complaints');
        const complaints = await httpResponse.json();
        return complaints;
    }

    async function renderComplaintTable() {
        const testComplaint = await getComplaints()

        for (const complaint of testComplaint) {
            const complaintRow = document.createElement('tr');

            const complaintIdData = document.createElement('td');
            complaintIdData.innerText = complaint.complaintId;

            const complaintTitleData = document.createElement('td');
            complaintTitleData.innerText = complaint.title;

            const complaintDescriptionData = document.createElement('td');
            complaintDescriptionData.innerText = complaint.description;

            const complaintStatusData = document.createElement('td');
            complaintStatusData.innerText = complaint.status;

            const complaintMeetingIdData = document.createElement('td');
            complaintMeetingIdData.innerText = complaint.meetingId;

            const highBtnTD = document.createElement('td');
            const highPriorityBtn = document.createElement('button');
            highBtnTD.appendChild(highPriorityBtn);
            highPriorityBtn.innerText = "High Priority";
            highPriorityBtn.dataset.complaintId = complaint.complaintId;
            highPriorityBtn.dataset.status = "high";
            highPriorityBtn.addEventListener('click', async event => {
                event.preventDefault();
                
                const complaintId = highPriorityBtn.dataset.complaintId;
                const status = highPriorityBtn.dataset.status;
                
                const response = await fetch(`http://localhost:8080/complaints/${complaintId}/${status}`,{
                        method:"PATCH"
                    });
                    const complaints = await response.json();
                    if (response.status === 202) {
                        alert("Status updated.")
                        location.reload();
                    } else if (response.status === 304) {
                        alert("Error. Status not changed.")
                    }
                });
            
            const lowBtnTD = document.createElement('td');
            const lowPriorityBtn = document.createElement('button');
            lowBtnTD.appendChild(lowPriorityBtn);
            lowPriorityBtn.innerText = "Low Priority";
            lowPriorityBtn.dataset.complaintId = complaint.complaintId;
            lowPriorityBtn.dataset.status = "low";
            lowPriorityBtn.addEventListener('click', async event => {
                event.preventDefault();
                
                const complaintId = lowPriorityBtn.dataset.complaintId;
                const status = lowPriorityBtn.dataset.status;
                
                const response = await fetch(`http://localhost:8080/complaints/${complaintId}/${status}`,{
                        method:"PATCH"
                    });
                    const complaints = await response.json();
                    if (response.status === 202) {
                        alert("Status updated.")
                        location.reload();
                    } else if (response.status === 304) {
                        alert("Error. Status not changed.")
                    }
                });

            const ignoreBtnTD = document.createElement('td');
            const ignoreBtn = document.createElement('button');
            ignoreBtnTD.appendChild(ignoreBtn);
            ignoreBtn.innerText = "Ignore";
            ignoreBtn.dataset.complaintId = complaint.complaintId;
            ignoreBtn.dataset.status = "ignore";
            ignoreBtn.addEventListener('click', async event => {
                event.preventDefault();
                
                const complaintId = ignoreBtn.dataset.complaintId;
                const status = ignoreBtn.dataset.status;
                
                const response = await fetch(`http://localhost:8080/complaints/${complaintId}/${status}`,{
                        method:"PATCH"
                    });
                    const complaints = await response.json();
                    if (response.status === 202) {
                        alert("Status updated.")
                        location.reload();
                    } else if (response.status === 304) {
                        alert("Error. Status not changed.")
                    }
                });


            complaintRow.appendChild(complaintIdData);
            complaintRow.appendChild(complaintTitleData);
            complaintRow.appendChild(complaintDescriptionData);
            complaintRow.appendChild(complaintStatusData);
            complaintRow.appendChild(complaintMeetingIdData);
            complaintRow.appendChild(highBtnTD);
            complaintRow.appendChild(lowBtnTD);
            complaintRow.appendChild(ignoreBtnTD);

            complaintTableBody.appendChild(complaintRow);
        }
    }

    renderComplaintTable();
</script>

</html>